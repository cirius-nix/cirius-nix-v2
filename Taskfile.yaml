version: 3
includes:
  secrets:
    taskfile: ./secrets/Taskfile.yaml
    optional: true
  hyprland:
    taskfile: ./Taskfile.hyprland.yaml
    optional: true
  kde:
    taskfile: ./Taskfile.kde.yaml
    optional: true
tasks:
  default:
    desc: "List all of tasks"
    cmds:
      - task -l
  build:
    desc: "Build new version"
    cmds:
      - sudo nixos-rebuild build
  switch:
    desc: "Build and switch to new nix version"
    cmds:
      - sudo nixos-rebuild switch {{ .CLI_ARGS }}
  gc:all:
    desc: "Delete all (non-current) generations"
    cmds:
      - nix-env --delete-generations old
      - nix-store --gc
  gc:2w:
    desc: "Delete generations older than 2 weeks"
    cmds:
      - nix-env --delete-generations 14d
      - nix-store --gc
  checkPerm:
    desc: "Check permission of a file or folder"
    vars:
      DEST: "{{ index .CLI_ARGS_LIST 0 }}"
    cmds:
      - stat -c "%a" {{ .DEST }}
  utils:extractFirefoxAddons:
    desc: "Extract firefox addons information for automatically installation"
    vars:
      URL: "{{ index .CLI_ARGS_LIST 0 }}"
    cmds:
      - |
        TMP_DIR=.temp/firefox-addons
        mkdir -p .temp/firefox-addons
        PACKAGE_NAME=$(echo "{{ .URL }}" | sed 's#.*/\([^/]*\)-[0-9].*#\1#')
        wget -O "${TMP_DIR}/${PACKAGE_NAME}.xpi" "{{ .URL }}"
        unzip -q -o "${TMP_DIR}/${PACKAGE_NAME}.xpi" -d "${TMP_DIR}/${PACKAGE_NAME}"
        cat "${TMP_DIR}/${PACKAGE_NAME}/manifest.json" | jq -r '.browser_specific_settings.gecko.id'
        echo $PACKAGE_NAME
  log:preboot:
    desc: "View the pre-boot logs"
    cmds:
      - sudo journalctl -b -1
  check:ldlib:
    desc: "Check ld lib"
    cmds:
      - nix-locate {{ .CLI_ARGS }}

  build-drv:
    desc: Build a derivation
    vars:
      DRV: '{{ index .CLI_ARGS_LIST 0 }}'
    cmds:
      - nix build --rebuild -L --keep-failed '{{ .DRV }}^*'
